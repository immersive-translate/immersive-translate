(()=>{var m="imt-subtitle-inject",p=class{from;to;constructor(t,r){this.from=t,this.to=r}sendMessages(t){globalThis.postMessage({eventType:m,to:this.to,from:this.from,type:t.type,data:t.data,id:t.id||new Date().getTime(),isAsync:!1})}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({type:t,data:r}){return new Promise(e=>{let n=this.getRandomId();globalThis.postMessage({eventType:m,to:this.to,from:this.from,type:t,data:r,id:n,isAsync:!0});let i=a=>{let u=a.data;m===u.eventType&&u.id===n&&u.to===this.from&&(e(u.data),globalThis.removeEventListener("message",i))};globalThis.addEventListener("message",i)})}handleMessageOnce(t){return new Promise(r=>{let e=n=>{let i=n.data;m===i.eventType&&i.type===t&&i.to===this.from&&(r(i.data),globalThis.removeEventListener("message",e))};globalThis.addEventListener("message",e)})}handleMessage(t,r){let e=n=>{let i=n.data;m===i.eventType&&i.type===t&&i.to===this.from&&r(i)};return globalThis.addEventListener("message",e),()=>{globalThis.removeEventListener("message",e)}}handleMessages(t){let r=({data:e})=>{m===e.eventType&&e.to===this.from&&t(e)};return globalThis.addEventListener("message",r),()=>{globalThis.removeEventListener("message",r)}}},_=new p("content-script","inject"),f=new p("inject","content-script"),E={get(s,t,r){return t in s?(...e)=>{let n=s[t];return typeof n=="function"?n.apply(s,e):Reflect.get(s,t,r)}:e=>s.sendAsyncMessages({type:t,data:e})}},y=new Proxy(f,E),C=new Proxy(_,E);function g(s){if(!s)return null;try{let t=s;return s.startsWith("//")?t=globalThis.location.protocol+s:s.startsWith("/")?t=`${globalThis.location.protocol}//${globalThis.location.host}${s}`:s.startsWith("http")||(t=`${globalThis.location.protocol}//${s}`),new URL(t).toString()}catch{return s}}var o=class{content=y;config;constructor(t){this.config=t,f.handleMessages(async({type:r,id:e,data:n})=>{let i=this[r];if(!i)return;let a=i.apply(this,[n]);a instanceof Promise&&(a=await a),f.sendMessages({id:e,data:a})})}triggerSubtitle(t){}async translateSubtitle(t){let r=await this.content.requestSubtitle({url:g(t._url)});if(r){if(this.config.responseType=="document"){let n=new DOMParser().parseFromString(r,"text/xml");Object.defineProperty(t,"responseXML",{value:n,writable:!1}),Object.defineProperty(t,"response",{value:n,writable:!1});return}let e=r;(t.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof r=="string"&&(e=new TextEncoder().encode(r).buffer),Object.defineProperty(t,"responseText",{value:e,writable:!1}),Object.defineProperty(t,"response",{value:e,writable:!1})}}async translateSubtitleWithResponse(t,r){return await this.content.requestSubtitle({url:g(t),responseText:r})}startRequestSubtitle(t){this.content.startRequestSubtitle({url:g(t)})}subtitleRequestError(t){this.content.subtitleRequestError({...t,url:g(t.url)})}async isOnlyResponse(){return this.config.hookType.includes("xhr_response")}async translateSubtitleWithFetch(t,r){let e={...r},n;return typeof t=="string"?n={url:t,method:"GET",headers:{}}:n=await D(t),e?.body&&(e.body=I(e.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:n,options:e})})}async getVideoMeta(t){}getCurrentTime(){return null}getCurrentDuration(){return null}isSubtitleRequest(t){return!this.config||!this.config.subtitleUrlRegExp||!t?!1:new RegExp(this.config.subtitleUrlRegExp).test(t||"")}};function D(s){if(s instanceof URL)return{url:s.href,method:"GET",headers:{}};let t=s.clone(),r={url:s.url,method:s.method,headers:Object.fromEntries(s.headers.entries())};if(t.body){let e=I(t.body);if(t.body!==e)return t.text().then(n=>(r.body=n,r));r.body=e}return Promise.resolve(r)}function I(s){if(!s)return s;if(s instanceof FormData||s instanceof URLSearchParams){let t={};for(let[r,e]of s.entries())t[r]=e;return t._formatBodyType="FormData",t}return s}var b=class extends o{timer=null;triggerSubtitle({force:t}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let r=document.querySelector(this.config.subtitleButtonSelector);if(r){let e=r.getAttribute("aria-pressed")==="true";e&&t?(r.click(),setTimeout(()=>{r.click()},100)):e||r.click();return}}if(this.config?.videoPlayerSelector){let r=document.querySelector(this.config.videoPlayerSelector);r?.toggleSubtitles(),setTimeout(()=>{r?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}async isOnlyResponse(){let t=await super.isOnlyResponse();return!t||(await this.getVideoMeta())?.videoDetails?.isLive?!1:t}getCurrentTime(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getCurrentTime():null}catch{return null}}getCurrentDuration(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getDuration():null}catch{return null}}sleep(t){return new Promise(r=>{setTimeout(()=>{r(null)},t)})}};var S=class extends o{timer=null;videoMeta={};lastVideoMeta=null;constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=r=>{let e=t(r);try{e&&e.result&&e.result.timedtexttracks&&e.result.movieId&&(this.videoMeta[e.result.movieId]=e.result,this.lastVideoMeta=e.result)}catch{}return e}}getVideoMeta(t){return this.lastVideoMeta}};var R=class extends o{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=r=>{let e=t(r);try{e?.asset?.captions?.length?this.videoMeta[e.id]=e?.asset:e?.previews&&e?.course&&e?.previews?.forEach(n=>{this.videoMeta[n.id]=n})}catch{}return e}}getVideoMeta(t){return this.videoMeta[t]}};var v=class extends o{timer=null;videoMeta={};constructor(t){super(t),this.hookJSON()}hookJSON(){let t=JSON.parse;JSON.parse=r=>{let e=t(r);try{if(e?.stream?.sources?.length&&e?.stream?.sources[0]?.complete?.url){let n=window.location.pathname.split("/");n.length>2&&n[n.length-2]==="video"&&(this.videoMeta[n[n.length-1]]=e.stream.sources[0].complete.url)}}catch{}return e}}getVideoMeta(t){return this.videoMeta[t]}};var M=class extends o{constructor(t){super(t)}async translateSubtitleWithFetch(t,r){this.main(t,r)}async main(t,r){let e=globalThis.__originalFetch;if(!e)return;let n=t;t instanceof Request&&(n=t.clone());let i=await e(n,r);if(!i.ok)return;let a=await i.json();a.transcripts_urls&&this.requestSubtitle(a.transcripts_urls)}async requestSubtitle(t){await l(),await this.content.requestSubtitle(t)}};var T=class extends o{constructor(t){super(t)}lang="";async translateSubtitleWithFetch(t,r){this.main(t,r)}async main(t,r){let e=globalThis.__originalFetch;if(!e)return;let n=this.getUrl(t);return/textstream_/.test(n)?this.parseLang(n):this.parseAllSubs(t,r,e)}getUrl(t){return t.toString()}async parseLang(t){let e=t.match(/textstream_(\w+)=/)?.[1];return!e||e==this.lang||(this.lang=e,await l(),this.content.changeLang(e)),null}async parseAllSubs(t,r,e){if(!e)return;let n=t;t instanceof Request&&(n=t.clone());let i=await e(n,r);if(!i.ok)return;let a=await i.json();a.text_track_urls&&this.requestSubtitle(a.text_track_urls)}async requestSubtitle(t){await l(),await this.content.requestSubtitle(t)}};var w=class extends o{requestedSubtitleUrls=new Set;constructor(t){super(t),t.id=="ted"&&this.ted()}ted(){try{let r=document.querySelector("#__NEXT_DATA__")?.textContent;if(!r)return;let n=JSON.parse(r)?.props?.pageProps?.videoData;if(!n)return;let i=n.playerData;if(!i)return;let a=typeof i=="string"?JSON.parse(i):i,u=a?.resources?.hls?.metadata,h=a?.languages;if(!u||!Array.isArray(h))return;let c=new URL(u,window.location.href);h.forEach(({languageCode:q})=>{if(!q)return;let j=q.toLowerCase(),L=c.pathname.replace(/metadata\.json$/,`subtitles/${j}/full.vtt`);if(L===c.pathname)return;let P=`${c.origin}${L}${c.search}`;this.requestedSubtitleUrls.has(P)||(this.requestedSubtitleUrls.add(P),this.requestSubtitle(P).catch(k=>{}))})}catch{}}async requestSubtitle(t){await l(),await this.translateSubtitleWithFetch(t)}};var O={hookRequest:()=>{}};async function U(){let s=await f.sendAsyncMessages({type:"getConfig"});if(!s)return;let r={youtube:b,netflix:S,webvtt:o,khanacademy:o,udemy:R,general:o,ebutt:o,hulu:M,mubi:T,edx:o,disneyplus:v,"fmp4.xml":o,multi_attach_vtt:w,twitter:o,subsrt:o,xml:o,text_track_dynamic:o,av:o}[s.type||""];if(!r)return;let e=new r(s);O.hookRequest(e,s)}O.hookRequest=(s,t)=>{if(t.hookType.includes("xhr")){let r=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send,n=function(){return this._url=typeof arguments[1]=="string"?arguments[1]:arguments[1]?.href,r.apply(this,arguments)},i=async function(){let a=this._url,u=s.isSubtitleRequest(a);return!a||!u?e.apply(this,arguments):(await s.isOnlyResponse()?(s.startRequestSubtitle(a),this.onreadystatechange=async()=>{let c=XMLHttpRequest.DONE;typeof c>"u"&&(c=4),this.readyState===c&&this.status===429&&s.subtitleRequestError({url:a,responseStatus:this.status}),this.readyState===c&&this.status===200&&await l()&&s.translateSubtitleWithResponse(a,this.responseText)}):await l()&&await s.translateSubtitle(this),e.apply(this,arguments))};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:n,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:i,writable:!0})}if(t.hookType.includes("fetch")){let r=globalThis.fetch;globalThis.__originalFetch=r,globalThis.fetch=async function(e,n){let i=typeof e=="string"?e:e.url||e.href;if(!s.isSubtitleRequest(i))return r(e,n);if(await l()){let h=await s.translateSubtitleWithFetch(e,n);return h?new Response(h):r(e,n)}return r(e,n)}}};var x=!1;function l(){if(!x){let s=f.handleMessageOnce("contentReady").then(()=>(x=!0,!0));return y.isContentReady(),Promise.race([s,new Promise(t=>{setTimeout(()=>{t(!1)},5e3)})])}return Promise.resolve(x)}l();U();})();
