(()=>{var g={BUILD_TIME:"2024-10-23T03:03:48.000Z",VERSION:"1.22.6",PROD:"1",PROD_API:"1",BETA:"0",userscript_domains:'["google.com","translate.googleapis.com","api-edge.cognitive.microsofttranslator.com","edge.microsoft.com","transmart.qq.com","translate.yandex.net","tmt.tencentcloudapi.com","www2.deepl.com","w.deepl.com","immersive-translate.owenyoung.com","generativelanguage.googleapis.com","chat.openai.com","bing.com","www.bing.com","open.volcengineapi.com","fanyi.baidu.com","api.fanyi.baidu.com","api.interpreter.caiyunai.com","api-free.deepl.com","api.deepl.com","api.openl.club","openapi.youdao.com","translate.volcengine.com","api.niutrans.com","immersivetranslate.com","test-api2.immersivetranslate.com","api2.immersivetranslate.com","config.immersivetranslate.com","app.immersivetranslate.com","dash.immersivetranslate.com","api.immersivetranslate.com","immersive-translate.deno.dev","www.googleapis.com","www.google-analytics.com","translate-pa.googleapis.com","api.cognitive.microsofttranslator.com","api.groq.com","api.x.ai","api.papago-chrome.com","api.openai.com","api.interpreter.caiyunai.com","api.cognitive.microsofttranslator.com","aidemo.youdao.com","dict.youdao.com","openai.azure.com","mt.aliyuncs.com","subhub.weixin.so","api.anthropic.com","localhost","127.0.0.1","ai.immersivetranslate.com","test-ai.immersivetranslate.com","openrouter.ai","dashscope.aliyuncs.com","api.deepseek.com","aip.baidubce.com","ark.cn-beijing.volces.com","hunyuan.tencentcloudapi.com","public-beta-api.siliconflow.cn","api.siliconflow.cn","open.bigmodel.cn","store.immersivetranslate.com","qianfan.baidubce.com"]',INSTALL_FROM:"firefox_zip",LOCAL_HTTPS:"0",MOCK:"0",DEBUG:"0",IMMERSIVE_TRANSLATE_FIREFOX:"1"};var b="imt-subtitle-inject",S=class{from;to;constructor(e,r){this.from=e,this.to=r}sendMessages(e){globalThis.postMessage({eventType:b,to:this.to,from:this.from,type:e.type,data:e.data,id:e.id||new Date().getTime(),isAsync:!1})}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({type:e,data:r}){return new Promise(t=>{let i=this.getRandomId();globalThis.postMessage({eventType:b,to:this.to,from:this.from,type:e,data:r,id:i,isAsync:!0});let s=u=>{let p=u.data;b===p.eventType&&p.id===i&&p.to===this.from&&(t(p.data),globalThis.removeEventListener("message",s))};globalThis.addEventListener("message",s)})}handleMessageOnce(e){return new Promise(r=>{let t=i=>{let s=i.data;b===s.eventType&&s.type===e&&s.to===this.from&&(r(s.data),globalThis.removeEventListener("message",t))};globalThis.addEventListener("message",t)})}handleMessage(e,r){let t=i=>{let s=i.data;b===s.eventType&&s.type===e&&s.to===this.from&&r(s)};return globalThis.addEventListener("message",t),()=>{globalThis.removeEventListener("message",t)}}handleMessages(e){let r=({data:t})=>{b===t.eventType&&t.to===this.from&&e(t)};return globalThis.addEventListener("message",r),()=>{globalThis.removeEventListener("message",r)}}},Y=new S("content-script","inject"),m=new S("inject","content-script"),G={get(n,e,r){return e in n?(...t)=>{let i=n[e];return typeof i=="function"?i.apply(n,t):Reflect.get(n,e,r)}:t=>n.sendAsyncMessages({type:e,data:t})}},y=new Proxy(m,G),me=new Proxy(Y,G);function T(n){if(!n)return null;try{let e=n;return n.startsWith("//")?e=globalThis.location.protocol+n:n.startsWith("/")?e=`${globalThis.location.protocol}//${globalThis.location.host}${n}`:n.startsWith("http")||(e=`${globalThis.location.protocol}//${n}`),new URL(e).toString()}catch{return n}}var a=class{content=y;config;constructor(e){this.config=e,m.handleMessages(async({type:r,id:t,data:i})=>{let s=this[r];if(!s)return;let u=s.apply(this,[i]);u instanceof Promise&&(u=await u),m.sendMessages({id:t,data:u})})}triggerSubtitle(e){}async translateSubtitle(e){let r=await this.content.requestSubtitle({url:T(e._url)});if(r){if(this.config.responseType=="document"){let i=new DOMParser().parseFromString(r,"text/xml");Object.defineProperty(e,"responseXML",{value:i,writable:!1}),Object.defineProperty(e,"response",{value:i,writable:!1});return}let t=r;(e.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof r=="string"&&(t=new TextEncoder().encode(r).buffer),Object.defineProperty(e,"responseText",{value:t,writable:!1}),Object.defineProperty(e,"response",{value:t,writable:!1})}}async translateSubtitleWithResponse(e,r){return await this.content.requestSubtitle({url:T(e),responseText:r})}startRequestSubtitle(e){this.content.startRequestSubtitle({url:T(e)})}subtitleRequestError(e){this.content.subtitleRequestError({...e,url:T(e.url)})}async isOnlyResponse(){return this.config.hookType.includes("xhr_response")}async translateSubtitleWithFetch(e,r){let t={...r},i;return typeof e=="string"?i={url:e,method:"GET",headers:{}}:i=await Z(e),t?.body&&(t.body=H(t.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:i,options:t})})}async getVideoMeta(e){}getCurrentTime(){return null}getCurrentDuration(){return null}isSubtitleRequest(e){return!this.config||!this.config.subtitleUrlRegExp||!e?!1:new RegExp(this.config.subtitleUrlRegExp).test(e||"")}};function Z(n){if(n instanceof URL)return{url:n.href,method:"GET",headers:{}};let e=n.clone(),r={url:n.url,method:n.method,headers:Object.fromEntries(n.headers.entries())};if(e.body){let t=H(e.body);if(e.body!==t)return e.text().then(i=>(r.body=i,r));r.body=t}return Promise.resolve(r)}function H(n){if(!n)return n;if(n instanceof FormData||n instanceof URLSearchParams){let e={};for(let[r,t]of n.entries())e[r]=t;return e._formatBodyType="FormData",e}return n}var R=class extends a{timer=null;triggerSubtitle({force:e}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let r=document.querySelector(this.config.subtitleButtonSelector);if(r){let t=r.getAttribute("aria-pressed")==="true";t&&e?(r.click(),setTimeout(()=>{r.click()},100)):t||r.click();return}}if(this.config?.videoPlayerSelector){let r=document.querySelector(this.config.videoPlayerSelector);r?.toggleSubtitles(),setTimeout(()=>{r?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}async isOnlyResponse(){let e=await super.isOnlyResponse();return!e||(await this.getVideoMeta())?.videoDetails?.isLive?!1:e}getCurrentTime(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getCurrentTime():null}catch{return null}}getCurrentDuration(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getDuration():null}catch{return null}}sleep(e){return new Promise(r=>{setTimeout(()=>{r(null)},e)})}};var M=class extends a{timer=null;videoMeta={};lastVideoMeta=null;constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=r=>{let t=e(r);try{t&&t.result&&t.result.timedtexttracks&&t.result.movieId&&(this.videoMeta[t.result.movieId]=t.result,this.lastVideoMeta=t.result)}catch{}return t}}getVideoMeta(e){return this.lastVideoMeta}};var v=class extends a{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=r=>{let t=e(r);try{t?.asset?.captions?.length?this.videoMeta[t.id]=t?.asset:t?.previews&&t?.course&&t?.previews?.forEach(i=>{this.videoMeta[i.id]=i})}catch{}return t}}getVideoMeta(e){return this.videoMeta[e]}};var C=class extends a{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=r=>{let t=e(r);try{if(t?.stream?.sources?.length&&t?.stream?.sources[0]?.complete?.url){let i=window.location.pathname.split("/");i.length>2&&i[i.length-2]==="video"&&(this.videoMeta[i[i.length-1]]=t.stream.sources[0].complete.url)}}catch{}return t}}getVideoMeta(e){return this.videoMeta[e]}};var P=class extends a{constructor(e){super(e)}async translateSubtitleWithFetch(e,r){this.main(e,r)}async main(e,r){let t=globalThis.__originalFetch;if(!t)return;let i=e;e instanceof Request&&(i=e.clone());let s=await t(i,r);if(!s.ok)return;let u=await s.json();u.transcripts_urls&&this.requestSubtitle(u.transcripts_urls)}async requestSubtitle(e){await c(),await this.content.requestSubtitle(e)}};var A=class extends a{constructor(e){super(e)}lang="";async translateSubtitleWithFetch(e,r){this.main(e,r)}async main(e,r){let t=globalThis.__originalFetch;if(!t)return;let i=this.getUrl(e);return/textstream_/.test(i)?this.parseLang(i):this.parseAllSubs(e,r,t)}getUrl(e){return e.toString()}async parseLang(e){let t=e.match(/textstream_(\w+)=/)?.[1];return!t||t==this.lang||(this.lang=t,await c(),this.content.changeLang(t)),null}async parseAllSubs(e,r,t){if(!t)return;let i=e;e instanceof Request&&(i=e.clone());let s=await t(i,r);if(!s.ok)return;let u=await s.json();u.text_track_urls&&this.requestSubtitle(u.text_track_urls)}async requestSubtitle(e){await c(),await this.content.requestSubtitle(e)}};var{Deno:K}=globalThis,ee=typeof K?.noColor=="boolean"?K.noColor:!0,te=!ee;function E(n,e){return{open:`\x1B[${n.join(";")}m`,close:`\x1B[${e}m`,regexp:new RegExp(`\\x1b\\[${e}m`,"g")}}function I(n,e){return te?`${e.open}${n.replace(e.regexp,e.open)}${e.close}`:n}function _(n){return I(n,E([2],22))}function k(n){return I(n,E([31],39))}function B(n){return I(n,E([32],39))}function D(n){return I(n,E([33],39))}var Ge=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|"),"g");function x(){return typeof process>"u"&&typeof Deno<"u"?Deno.env.toObject():g}var je=x();var $e=x().PROD==="1",ze=x().PROD!=="1";var re="";function L(){return re||globalThis.navigator.userAgent}function oe(){let n=L();return n.includes("ImtFxiOS")||n.includes("ImtiOS")}function ie(){let n=L();return n.includes("ImtFxAndroid")||n.includes("ImtFxAOS")}function V(){if(!ie())return!1;let n=L();return n.endsWith("official_cn")||n.includes("mainlandStore")}function j(){return oe()?L().includes("mainland"):!1}var N="DENO",w="CHROME",F="FIREFOX";function ae(n){let e;try{let r=navigator?.userAgent||"";/firefox/i.test(r)||typeof InstallTrigger<"u"?e=F:/deno/i.test(r)?e=N:/chrome/i.test(r)&&(e=w)}catch{}return n===w&&e===w||n===F&&e===F||n===N&&e===N}function $(n=!1){let e=x();return V()||j()||!n&&e.region_plugin=="mainland"?!0:ae(w)&&e.IMMERSIVE_TRANSLATE_CN_CHROME==="1"}var o="immersiveTranslate",d="Immersive Translate",l="immersive-translate",z="imt";var ft=o+"DeeplGlobalState",ht=o+"BingGlobalState",Tt=o+"YandexGlobalState",xt=o+"BaiduQianfanGlobalConfigStorageKey",St=o+"SiliconCloudGlobalConfigStorageKey",yt=o+"IMT_TRANSLATION_COMMON_TOKEN",Rt=o+"ZhipuGlobalConfigStorageKey";var Mt=o+"GoogleAccessToken",vt=o+"AuthFlow",Ct=l+"-config-latest.json",Pt=o+"AuthState",At=o+"IframeMessage",Et=o+"WaitForRateLimit",It=o+"DocumentMessageAsk",kt=o+"DocumentMessageTellThirdParty",Lt=o+"showError",wt=o+"showModal",Ut=o+"showDialog",Ot=o+"showToast",_t=o+"tokenUsageChange",Bt=o+"DocumentMessageThirdPartyTell",Dt=o+"DocumentMessageEventUpload",Nt=o+"DocumentMessageTypeStopJsSDK",Ft=o+"DocumentMessageHandler",Wt=o+"DocumentSetFloatBallActive",qt=`${o}Share`,Gt=`${o}ShowFloatBallGuide`,Ht=`${o}ShowPopupModalGuide`,Kt=o+"DocumentMessageTempEnableSubtitleChanged",Vt=o+"DocumentMessageUpdateQuickButtonAiSubtitle",jt=`${o}ToggleMouseHoverTranslateDirectly`,$t=`${o}ReqDraft`,zt=`${o}ResDraft`,Jt=`${o}Container`,Qt=`${o}SpecifiedContainer`;var Xt=`${o}PageTranslatedStatus`,Yt=`${o}MangaTranslatedStatus`,Zt=`${o}PageUrlChanged`,en=`${o}ReceiveCommand`,tn=o+"LastUseMouseHoverTime",nn=o+"LastUseInputTime",rn=o+"LastUseManualTranslatePageTime",on=`${o}PopupReceiveMessage`,an=`${o}SidePanelReceiveMessage`,sn=o+"DocumentMessageEventTogglePopup",ln=`${o}Mark`,gn=`${o}Root`,un=`${o}Walked`,cn=`data-${l}-walked`,pn=`${o}Paragraph`,mn=`data-${l}-paragraph`,dn=`data-${l}-translation-element-mark`,bn=`${o}TranslationElementMark`,fn=`${o}TranslatedMark`,hn=`${l}-input-injected-css`,Tn=`${o}LoadingId`,xn=`data-${l}-loading-id`,Sn=`${o}ErrorId`,yn=`data-${l}-error-id`,Rn=`${o}AtomicBlockMark`,Mn=`${o}ExcludeMark`,vn=`data-${l}-exclude-mark`,Cn=`${o}StayOriginalMark`,Pn=`${o}PreWhitespaceMark`,An=`${o}InlineMark`,En=`${o}BlockMark`,In=`${o}Left`,kn=`${o}Right`,Ln=`${o}Width`,wn=`${o}Height`,Un=`${o}Top`,On=`${o}FontSize`;var _n=`${o}GlobalStyleMark`;var Bn=`${l}-target-wrapper`,Dn=`${l}-pdf-target-container`,Nn=`${l}-target-inner`,Fn=`${l}-source-wrapper`,Wn=`${l}-target-translation-block-wrapper`,qn=`${l}-root-translation-theme`,Gn=`${o}RootTranslationTheme`,Hn=`${l}-target-translation-vertical-block-wrapper`,Kn=`${l}-target-translation-pdf-block-wrapper`,Vn=`${l}-target-translation-pre-whitespace`,jn=`${l}-target-translation-inline-wrapper`;var $n=[{name:"touch",shortcuts:[{command:"touchShortcutsToggleTranslatePage",type:"finger"},{command:"touchShortcutsToggleTranslationMask",type:"finger"},{command:"touchShortcutsToggleTranslatePageOnlyTranslation",type:"finger"},{command:"touchShortcutsToggleTranslateTouchElement",type:"finger"},{command:"touchShortcutsInputTranslate",type:"finger"}]},{name:"main",shortcuts:["toggleTranslatePage","shareToDraft","translateInputBox","toggleSidePanel","openAiWritingModal"]},{name:"mouse",shortcuts:[{command:"mouseHoverHoldKey",type:"mouseHoverHoldKey"},"toggleMouseHoverTranslateDirectly"]},{name:"others",shortcuts:["toggleTranslationMask","toggleTranslateToThePageEndImmediately","toggleTranslateTheMainPage","toggleOnlyTransation","toggleTranslateTheWholePage","toggleVideoSubtitlePreTranslation"]},{name:"shortcutsForTranslationServices",shortcuts:$()?[{command:"translateWithCustom1",type:"translateWithCustom"},{command:"translateWithCustom2",type:"translateWithCustom"},{command:"translateWithCustom3",type:"translateWithCustom"}]:["translateWithDeepL","translateWithGoogle","translateWithOpenAI","translateWithBing","translateWithTransmart","translateWithGemini","translateWithClaude",{command:"translateWithCustom1",type:"translateWithCustom"},{command:"translateWithCustom2",type:"translateWithCustom"},{command:"translateWithCustom3",type:"translateWithCustom"}]}];var zn={type:o+"ChildFrameToRootFrameIdentifier"};var Jn=50*1e4,Qn=`[${z}-ctx-divider]`,Xn=`${z}_context_preview`;var Yn=`${o}_selection_update_params`,Zn=`data-${l}-subtitle-type`,er=`data-${l}-ai-subtitle-url`,tr=`data-${l}-has-subtitle`;var se=["google","bing","zhipu","siliconcloud","transmart","yandex"],le=["deepseek","openai","claude","gemini","zhipu-pro","deepl"],ge=["openai","claude","gemini"],nr=[...se,...le,...ge];var rr=l+"-large-cache";var f=console,W=class{#e=performance.now();reset(){this.#e=performance.now()}stop(e){let r=performance.now(),t=Math.round(r-this.#e),i=B;t>1e4?i=k:t>1e3&&(i=D),f.debug(_(d+" TIMING:"),e,"in",i(t+"ms")),this.#e=r}},q=class{#e=1;get level(){return this.#e}setLevel(e){switch(e){case"debug":this.#e=0;break;case"info":this.#e=1;break;case"warn":this.#e=2;break;case"error":this.#e=3;break;case"fatal":this.#e=4;break}}debug(...e){this.#e<=0&&f.log(_(d+" DEBUG:"),...e)}v(...e){this.#e<=0}info(...e){this.#e<=1&&f.log(B(d+" INFO:"),...e)}l(...e){this.#e<=1}warn(...e){this.#e<=2&&f.warn(D(d+" WARN:"),...e)}error(...e){this.#e<=3&&f.error(k(d+" ERROR:"),...e)}fatal(...e){this.#e<=4&&f.error(k(d+" FATAL:"),...e)}timing(){return this.level===0?new W:{reset:()=>{},stop:()=>{}}}},J=new q;var Q={hookRequest:()=>{}};async function ue(){let n=await m.sendAsyncMessages({type:"getConfig"});if(!n)return;let r={youtube:R,netflix:M,webvtt:a,khanacademy:a,udemy:v,general:a,ebutt:a,hulu:P,mubi:A,edx:a,disneyplus:C,"fmp4.xml":a,multi_attach_vtt:a,twitter:a,subsrt:a,xml:a,text_track_dynamic:a,av:a}[n.type||""];if(!r)return;let t=new r(n);Q.hookRequest(t,n)}Q.hookRequest=(n,e)=>{if(e.hookType.includes("xhr")){let r=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,i=function(){return this._url=typeof arguments[1]=="string"?arguments[1]:arguments[1]?.href,r.apply(this,arguments)},s=async function(){let u=this._url,p=n.isSubtitleRequest(u);return!u||!p?t.apply(this,arguments):(await n.isOnlyResponse()?(n.startRequestSubtitle(u),this.onreadystatechange=async()=>{let h=XMLHttpRequest.DONE;typeof h>"u"&&(h=4),this.readyState===h&&this.status===429&&n.subtitleRequestError({url:u,responseStatus:this.status}),this.readyState===h&&this.status===200&&await c()&&n.translateSubtitleWithResponse(u,this.responseText)}):await c()&&await n.translateSubtitle(this),t.apply(this,arguments))};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:i,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:s,writable:!0})}if(e.hookType.includes("fetch")){let r=globalThis.fetch;globalThis.__originalFetch=r,globalThis.fetch=async function(t,i){let s=typeof t=="string"?t:t.url||t.href;if(!n.isSubtitleRequest(s))return r(t,i);if(await c()){let O=await n.translateSubtitleWithFetch(t,i);return O?new Response(O):r(t,i)}return r(t,i)}}};var U=!1;function c(){if(!U){let n=m.handleMessageOnce("contentReady").then(()=>(U=!0,!0));return y.isContentReady(),Promise.race([n,new Promise(e=>{setTimeout(()=>{U||J.warn("waitPluginDone timeout"),e(!1)},5e3)})])}return Promise.resolve(U)}c();ue();})();
