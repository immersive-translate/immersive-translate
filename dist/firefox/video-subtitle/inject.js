(()=>{var c={BUILD_TIME:"2025-08-05T08:11:55.000Z",VERSION:"1.20.3",PROD:"1",REDIRECT_URL:"https://dash.immersivetranslate.com/auth-done/",PROD_API:"1",BETA:"0",userscript_domains:'["google.com","translate.googleapis.com","api-edge.cognitive.microsofttranslator.com","edge.microsoft.com","transmart.qq.com","translate.yandex.net","tmt.tencentcloudapi.com","www2.deepl.com","w.deepl.com","immersive-translate.owenyoung.com","generativelanguage.googleapis.com","chat.openai.com","bing.com","www.bing.com","open.volcengineapi.com","fanyi.baidu.com","api.fanyi.baidu.com","api.interpreter.caiyunai.com","api-free.deepl.com","api.deepl.com","api.openl.club","openapi.youdao.com","translate.volcengine.com","api.niutrans.com","immersivetranslate.com","test-api2.immersivetranslate.com","api2.immersivetranslate.com","config.immersivetranslate.com","app.immersivetranslate.com","dash.immersivetranslate.com","api.immersivetranslate.com","immersive-translate.deno.dev","www.googleapis.com","www.google-analytics.com","translate-pa.googleapis.com","api.cognitive.microsofttranslator.com","api.groq.com","api.x.ai","api.papago-chrome.com","api.openai.com","api.interpreter.caiyunai.com","api.cognitive.microsofttranslator.com","aidemo.youdao.com","dict.youdao.com","openai.azure.com","mt.aliyuncs.com","subhub.weixin.so","api.anthropic.com","localhost","127.0.0.1","ai.immersivetranslate.com","test-ai.immersivetranslate.com","openrouter.ai","dashscope.aliyuncs.com","api.deepseek.com","aip.baidubce.com","ark.cn-beijing.volces.com","hunyuan.tencentcloudapi.com","public-beta-api.siliconflow.cn","api.siliconflow.cn","open.bigmodel.cn","store.immersivetranslate.com","qianfan.baidubce.com"]',MOCK:"0",DEBUG:"0",IMMERSIVE_TRANSLATE_FIREFOX:"1",INSTALL_FROM:"firefox_zip"};var h="imt-subtitle-inject",v=class{from;to;constructor(e,n){this.from=e,this.to=n}sendMessages(e){globalThis.postMessage({eventType:h,to:this.to,from:this.from,type:e.type,data:e.data,id:e.id||new Date().getTime(),isAsync:!1})}getRandomId(){return(new Date().getTime()+Math.random())*Math.random()}sendAsyncMessages({type:e,data:n}){return new Promise(t=>{let i=this.getRandomId();globalThis.postMessage({eventType:h,to:this.to,from:this.from,type:e,data:n,id:i,isAsync:!0});let s=u=>{let f=u.data;h===f.eventType&&f.id===i&&f.to===this.from&&(t(f.data),globalThis.removeEventListener("message",s))};globalThis.addEventListener("message",s)})}handleMessageOnce(e){return new Promise(n=>{let t=i=>{let s=i.data;h===s.eventType&&s.type===e&&s.to===this.from&&(n(s.data),globalThis.removeEventListener("message",t))};globalThis.addEventListener("message",t)})}handleMessage(e,n){let t=i=>{let s=i.data;h===s.eventType&&s.type===e&&s.to===this.from&&n(s)};return globalThis.addEventListener("message",t),()=>{globalThis.removeEventListener("message",t)}}handleMessages(e){let n=({data:t})=>{h===t.eventType&&t.to===this.from&&e(t)};return globalThis.addEventListener("message",n),()=>{globalThis.removeEventListener("message",n)}}},oe=new v("content-script","inject"),T=new v("inject","content-script"),z={get(r,e,n){return e in r?(...t)=>{let i=r[e];return typeof i=="function"?i.apply(r,t):Reflect.get(r,e,n)}:t=>r.sendAsyncMessages({type:e,data:t})}},A=new Proxy(T,z),xe=new Proxy(oe,z);function _(r){if(!r)return null;try{let e=r;return r.startsWith("//")?e=globalThis.location.protocol+r:r.startsWith("/")?e=`${globalThis.location.protocol}//${globalThis.location.host}${r}`:r.startsWith("http")||(e=`${globalThis.location.protocol}//${r}`),new URL(e).toString()}catch(e){return console.error(e),r}}var a=class{content=A;config;constructor(e){this.config=e,T.handleMessages(async({type:n,id:t,data:i})=>{let s=this[n];if(!s)return;let u=s.apply(this,[i]);u instanceof Promise&&(u=await u),T.sendMessages({id:t,data:u})})}triggerSubtitle(e){}async translateSubtitle(e){let n=await this.content.requestSubtitle({url:_(e._url)});if(n){if(this.config.responseType=="document"){let i=new DOMParser().parseFromString(n,"text/xml");Object.defineProperty(e,"responseXML",{value:i,writable:!1}),Object.defineProperty(e,"response",{value:i,writable:!1});return}let t=n;(e.responseType=="arraybuffer"||this.config.responseType=="arraybuffer")&&typeof n=="string"&&(t=new TextEncoder().encode(n).buffer),Object.defineProperty(e,"responseText",{value:t,writable:!1}),Object.defineProperty(e,"response",{value:t,writable:!1})}}async translateSubtitleWithResponse(e,n){return await this.content.requestSubtitle({url:_(e),responseText:n})}startRequestSubtitle(e){this.content.startRequestSubtitle({url:_(e)})}subtitleRequestError(e){this.content.subtitleRequestError({...e,url:_(e.url)})}async isOnlyResponse(){return this.config.hookType.includes("xhr_response")}async translateSubtitleWithFetch(e,n){let t={...n},i;return typeof e=="string"?i={url:e,method:"GET",headers:{}}:i=await ie(e),t?.body&&(t.body=J(t.body)),this.content.requestSubtitle({fetchInfo:JSON.stringify({input:i,options:t})})}async getVideoMeta(e){}getCurrentTime(){return null}getCurrentDuration(){return null}isSubtitleRequest(e){return!this.config||!this.config.subtitleUrlRegExp||!e?!1:new RegExp(this.config.subtitleUrlRegExp).test(e||"")}};function ie(r){if(r instanceof URL)return{url:r.href,method:"GET",headers:{}};let e=r.clone(),n={url:r.url,method:r.method,headers:Object.fromEntries(r.headers.entries())};if(e.body){let t=J(e.body);if(e.body!==t)return e.text().then(i=>(n.body=i,n));n.body=t}return Promise.resolve(n)}function J(r){if(!r)return r;if(r instanceof FormData||r instanceof URLSearchParams){let e={};for(let[n,t]of r.entries())e[n]=t;return e._formatBodyType="FormData",e}return r}var P=class extends a{timer=null;triggerSubtitle({force:e}){setTimeout(()=>{if(this.config?.subtitleButtonSelector){let n=document.querySelector(this.config.subtitleButtonSelector);if(n){let t=n.getAttribute("aria-pressed")==="true";t&&e?(n.click(),setTimeout(()=>{n.click()},100)):t||n.click();return}}if(this.config?.videoPlayerSelector){let n=document.querySelector(this.config.videoPlayerSelector);n?.toggleSubtitles(),setTimeout(()=>{n?.toggleSubtitles()},100)}},1e3)}async getVideoMeta(){if(!this.config.videoPlayerSelector)return null;try{return await this.sleep(100),document.querySelector(this.config.videoPlayerSelector)?.getPlayerResponse()}catch{return null}}async isOnlyResponse(){let e=await super.isOnlyResponse();return!e||(await this.getVideoMeta())?.videoDetails?.isLive?!1:e}getCurrentTime(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getCurrentTime():null}catch{return null}}getCurrentDuration(){try{return this.config.videoPlayerSelector?document.querySelector(this.config.videoPlayerSelector)?.getDuration():null}catch{return null}}sleep(e){return new Promise(n=>{setTimeout(()=>{n(null)},e)})}};var C=class extends a{timer=null;videoMeta={};lastVideoMeta=null;constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{t&&t.result&&t.result.timedtexttracks&&t.result.movieId&&(this.videoMeta[t.result.movieId]=t.result,this.lastVideoMeta=t.result)}catch(i){console.log(i)}return t}}getVideoMeta(e){return this.lastVideoMeta}};var I=class extends a{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{t?.asset?.captions?.length?this.videoMeta[t.id]=t?.asset:t?.previews&&t?.course&&t?.previews?.forEach(i=>{this.videoMeta[i.id]=i})}catch(i){console.error(i)}return t}}getVideoMeta(e){return this.videoMeta[e]}};var L=class extends a{timer=null;videoMeta={};constructor(e){super(e),this.hookJSON()}hookJSON(){let e=JSON.parse;JSON.parse=n=>{let t=e(n);try{if(t?.stream?.sources?.length&&t?.stream?.sources[0]?.complete?.url){let i=window.location.pathname.split("/");i.length>2&&i[i.length-2]==="video"&&(this.videoMeta[i[i.length-1]]=t.stream.sources[0].complete.url)}}catch(i){console.error(i)}return t}}getVideoMeta(e){return this.videoMeta[e]}};var k=class extends a{constructor(e){super(e)}async translateSubtitleWithFetch(e,n){this.main(e,n)}async main(e,n){let t=globalThis.__originalFetch;if(!t)return;let i=e;e instanceof Request&&(i=e.clone());let s=await t(i,n);if(!s.ok)return;let u=await s.json();u.transcripts_urls&&this.requestSubtitle(u.transcripts_urls)}async requestSubtitle(e){await d(),await this.content.requestSubtitle(e)}};var U=class extends a{constructor(e){super(e)}lang="";async translateSubtitleWithFetch(e,n){this.main(e,n)}async main(e,n){let t=globalThis.__originalFetch;if(!t)return;let i=this.getUrl(e);return/textstream_/.test(i)?this.parseLang(i):this.parseAllSubs(e,n,t)}getUrl(e){return e.toString()}async parseLang(e){let t=e.match(/textstream_(\w+)=/)?.[1];return!t||t==this.lang||(this.lang=t,await d(),this.content.changeLang(t)),null}async parseAllSubs(e,n,t){if(!t)return;let i=e;e instanceof Request&&(i=e.clone());let s=await t(i,n);if(!s.ok)return;let u=await s.json();u.text_track_urls&&this.requestSubtitle(u.text_track_urls)}async requestSubtitle(e){await d(),await this.content.requestSubtitle(e)}};var{Deno:Q}=globalThis,ae=typeof Q?.noColor=="boolean"?Q.noColor:!0,se=!ae;function O(r,e){return{open:`\x1B[${r.join(";")}m`,close:`\x1B[${e}m`,regexp:new RegExp(`\\x1b\\[${e}m`,"g")}}function w(r,e){return se?`${e.open}${r.replace(e.regexp,e.open)}${e.close}`:r}function D(r){return w(r,O([2],22))}function B(r){return w(r,O([31],39))}function F(r){return w(r,O([32],39))}function H(r){return w(r,O([33],39))}var Ve=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|"),"g");function M(){return typeof process>"u"&&typeof Deno<"u"?Deno.env.toObject():c}var $=M();function S(){return $.PROD==="1"}function N(){return $.PROD_API==="1"}function Y(){if($.IMMERSIVE_TRANSLATE_SAFARI==="1")return!0;if(typeof globalThis.immersiveTranslateBrowserAPI<"u"&&globalThis.immersiveTranslateBrowserAPI.runtime&&globalThis.immersiveTranslateBrowserAPI.runtime.getManifest){let e=globalThis.immersiveTranslateBrowserAPI.runtime.getManifest();return!!(e&&e._isSafari)}else return!1}var Ye=M().PROD==="1",Xe=M().PROD!=="1";var o="immersiveTranslate",b="Immersive Translate",l="immersive-translate",X="imt",ge="immersivetranslate";var p="immersivetranslate.com",ue=`https://config.${p}/`,rt=`https://app.${p}/`,g=S()||N()?`https://${p}/`:`https://test.${p}/`,G=`https://dash.${p}/`,ot=S()||N()?`https://api2.${p}/`:`https://test-api2.${p}/`,it=S()||N()?`https://ai.${p}/`:`https://test-ai.${p}/`,at=`https://assets.${ge}.cn/`,Z=g+"accounts/login?from=plugin",K=g+"profile/",m=g+"auth/pricing/",x=g+"pricing/";Y()&&(m=g+"accounts/safari-iap/",x=g+"accounts/safari-iap/");var st=S()?`https://onboarding.${p}/`:`https://test-onboarding.${p}/`,ee=`https://github.com/${l}/${l}/`,lt=`https://s.${p}/`;var gt=o+"DeeplGlobalState",ut=o+"BingGlobalState",ct=o+"YandexGlobalState",pt=o+"BaiduQianfanGlobalConfigStorageKey",mt=o+"SiliconCloudGlobalConfigStorageKey",dt=o+"ZhipuGlobalConfigStorageKey";var bt=o+"GoogleAccessToken",ft=o+"AuthFlow",Tt=l+"-config-latest.json",xt=o+"AuthState",ht=o+"IframeMessage",St=o+"WaitForRateLimit",yt=o+"DocumentMessageAsk",Rt=o+"DocumentMessageTellThirdParty",_t=o+"showError",Mt=o+"showModal",Et=o+"showDialog",vt=o+"showToast",At=o+"tokenUsageChange",Pt=o+"DocumentMessageThirdPartyTell",Ct=o+"DocumentMessageEventUpload",It=o+"DocumentMessageTypeStopJsSDK",Lt=o+"DocumentMessageHandler",kt=o+"DocumentSetFloatBallActive",Ut=`${o}Share`,Ot=`${o}ShowFloatBallGuide`,wt=`${o}ShowPopupModalGuide`,Dt=o+"DocumentMessageTempEnableSubtitleChanged",Bt=o+"DocumentMessageUpdateQuickButtonAiSubtitle",Ft=`${o}ToggleMouseHoverTranslateDirectly`,Nt=`${o}ReqDraft`,Gt=`${o}ResDraft`,Wt=`${o}Container`,qt=`${o}SpecifiedContainer`;var Ht=`${o}PageTranslatedStatus`,$t=`${o}MangaTranslatedStatus`,Kt=`${o}PageUrlChanged`,jt=`${o}ReceiveCommand`,Vt=o+"LastUseMouseHoverTime",zt=o+"LastUseInputTime",Jt=o+"LastUseManualTranslatePageTime",Qt=`${o}PopupReceiveMessage`,Yt=o+"DocumentMessageEventTogglePopup",Xt=`${ue}default_config.json`,Zt=`${o}Mark`,en=`${o}Root`,tn=`${o}Walked`,nn=`data-${l}-walked`,rn=`${o}Paragraph`,on=`data-${l}-paragraph`,an=`data-${l}-translation-element-mark`,sn=`${o}TranslationElementMark`,ln=`${o}TranslatedMark`,gn=`${l}-input-injected-css`,un=`${o}LoadingId`,cn=`data-${l}-loading-id`,pn=`${o}ErrorId`,mn=`data-${l}-error-id`,dn=`${o}AtomicBlockMark`,bn=`${o}ExcludeMark`,fn=`data-${l}-exclude-mark`,Tn=`${o}StayOriginalMark`,xn=`${o}PreWhitespaceMark`,hn=`${o}InlineMark`,Sn=`${o}BlockMark`,yn=`${o}Left`,Rn=`${o}Right`,_n=`${o}Width`,Mn=`${o}Height`,En=`${o}Top`,vn=`${o}FontSize`;var An=`${o}GlobalStyleMark`;var Pn=`${l}-target-wrapper`,Cn=`${l}-pdf-target-container`,In=`${l}-target-inner`,Ln=`${l}-source-wrapper`,kn=`${l}-target-translation-block-wrapper`,Un=`${l}-root-translation-theme`,On=`${o}RootTranslationTheme`,wn=`${l}-target-translation-vertical-block-wrapper`,Dn=`${l}-target-translation-pdf-block-wrapper`,Bn=`${l}-target-translation-pre-whitespace`,Fn=`${l}-target-translation-inline-wrapper`;var Nn=["https://immersive-translate.owenyoung.com/options/","https://immersive-translate.owenyoung.com/auth-done/",G,G+"auth-done/","http://localhost:8000/dist/userscript/options/","http://localhost:8000/auth-done/","http://192.168.50.9:8000/dist/userscript/options/","http://192.168.31.51:8000/dist/userscript/options/","http://192.168.1.72:8000/dist/userscript/options/","https://www.deepl.com/translator","translate.google.com","http://localhost:8000/options/","http://192.168.50.9:8000/options/","http://192.168.31.51:8000/options/","http://192.168.1.72:8000/options/"];var Gn=g+"docs/communities/",Wn=ee+"issues/1809",qn=ee+"issues/1179",Hn={type:o+"ChildFrameToRootFrameIdentifier"};var $n=S()?G+"#general":"http://localhost:8000/dist/userscript/options/#general";var ce=G+"#general",Kn=g+"accounts/login?from=plugin&return_url="+encodeURIComponent(ce),jn=Z+"&utm_source=extension&utm_medium=extension&utm_campaign=error_modal",Vn=Z+"&utm_source=extension&utm_medium=extension&utm_campaign=free_ai_subtitle",pe=g+"download/",zn=g+"topup",me=g+"topup?type=open_ai&",de=g+"topup?type=deepl&",Jn=g+"topup?type=comics&",Qn=g+"topup?type=asr",Yn=x+"?utm_source=extension&utm_medium=extension&utm_campaign=popup_more",Xn=m+"?utm_source=extension&utm_medium=extension&utm_campaign=manga_guide",Zn=pe+"?utm_source=extension&utm_medium=extension&utm_campaign=options_nav",er=x+"?utm_source=extension&utm_medium=extension&utm_campaign=popup_footer",tr=x+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",nr=x+"?utm_source=extension&utm_medium=extension&utm_campaign=max_",rr=x+"?utm_source=extension&utm_medium=extension&utm_campaign=float_ball",or=K+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",ir=m+"?utm_source=extension&utm_medium=extension&utm_campaign=subtitle_download",ar=m+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal_ai_subtitle",sr=me+"utm_source=extension&utm_medium=extension&utm_campaign=error_modal",lr=de+"utm_source=extension&utm_medium=extension&utm_campaign=error_modal",gr=g+"topup?utm_source=extension&utm_medium=extension&utm_campaign=error_modal",ur=x+"?utm_source=extension&utm_medium=extension&utm_campaign=option_sync_config",cr=K+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal&upgradeFromTrial=true",pr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=manga_intro",mr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=image_intro",dr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=image_client",br=m+"?utm_source=extension&utm_medium=extension&utm_campaign=yt_ai_asr",fr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=",Tr=g+"accounts/usage",xr=g+"docs/usage/",hr=g+"docs/communities/",E=M().TRANSLATE_FILE_URL,Sr=E+"?utm_source=extension&utm_medium=extension&utm_campaign=options_nav",yr=E+"?utm_source=extension&utm_medium=extension&utm_campaign=float_ball",Rr=`${E}download-subtitle/`,_r=`${E}pdf-pro/`,Mr=`${E}text/`;var Er=g+"docs/usage/";var vr=`https://analytics.${p}/collect`,Ar=`https://analytics.${p}/internal`,Pr=`${g}activities/components/image-pro`;var Cr=50*1e4,Ir=`[${X}-ctx-divider]`,Lr=`${X}_context_preview`;var kr=`${o}_selection_update_params`,Ur=`data-${l}-subtitle-type`,Or=`data-${l}-ai-subtitle-url`,wr=`data-${l}-has-subtitle`;var Dr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=freeImageError";var Br=l+"-large-cache";var Fr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=live_subtitle_btn";var Nr=m+"?utm_source=extension&utm_medium=extension&utm_campaign=no_subtitle_quick_button",Gr=K+"?utm_source=extension&utm_medium=extension&utm_campaign=error_modal_ai_subtitle&upgradeFromTrial=true";var y=console,j=class{#e=performance.now();reset(){this.#e=performance.now()}stop(e){let n=performance.now(),t=Math.round(n-this.#e),i=F;t>1e4?i=B:t>1e3&&(i=H),y.debug(D(b+" TIMING:"),e,"in",i(t+"ms")),this.#e=n}},V=class{#e=1;get level(){return this.#e}setLevel(e){switch(e){case"debug":this.#e=0;break;case"info":this.#e=1;break;case"warn":this.#e=2;break;case"error":this.#e=3;break;case"fatal":this.#e=4;break}}debug(...e){this.#e<=0&&y.log(D(b+" DEBUG:"),...e)}v(...e){this.#e<=0&&console.log(D(b+" VERBOSE:"),...e)}info(...e){this.#e<=1&&y.log(F(b+" INFO:"),...e)}l(...e){this.#e<=1&&console.log(F(b+" TEMP INFO:"),...e)}warn(...e){this.#e<=2&&y.warn(H(b+" WARN:"),...e)}error(...e){this.#e<=3&&y.error(B(b+" ERROR:"),...e)}fatal(...e){this.#e<=4&&y.error(B(b+" FATAL:"),...e)}timing(){return this.level===0?new j:{reset:()=>{},stop:()=>{}}}},te=new V;var ne={hookRequest:()=>{}};async function be(){let r=await T.sendAsyncMessages({type:"getConfig"});if(!r)return;let n={youtube:P,netflix:C,webvtt:a,khanacademy:a,udemy:I,general:a,ebutt:a,hulu:k,mubi:U,edx:a,disneyplus:L,"fmp4.xml":a,multi_attach_vtt:a,twitter:a,subsrt:a,xml:a,text_track_dynamic:a,av:a}[r.type||""];if(!n)return;let t=new n(r);ne.hookRequest(t,r)}ne.hookRequest=(r,e)=>{if(e.hookType.includes("xhr")){let n=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,i=function(){return this._url=arguments[1],n.apply(this,arguments)},s=async function(){let u=this._url,f=r.isSubtitleRequest(u);return!u||!f?t.apply(this,arguments):(await r.isOnlyResponse()?(r.startRequestSubtitle(u),this.onreadystatechange=async()=>{let R=XMLHttpRequest.DONE;typeof R>"u"&&(R=4),this.readyState===R&&this.status===429&&r.subtitleRequestError({url:u,responseStatus:this.status}),this.readyState===R&&this.status===200&&await d()&&r.translateSubtitleWithResponse(u,this.responseText)}):await d()&&await r.translateSubtitle(this),t.apply(this,arguments))};Object.defineProperty(XMLHttpRequest.prototype,"open",{value:i,writable:!0}),Object.defineProperty(XMLHttpRequest.prototype,"send",{value:s,writable:!0})}if(e.hookType.includes("fetch")){let n=globalThis.fetch;globalThis.__originalFetch=n,globalThis.fetch=async function(t,i){let s=typeof t=="string"?t:t.url||t.href;if(!r.isSubtitleRequest(s))return n(t,i);if(await d()){let q=await r.translateSubtitleWithFetch(t,i);return q?new Response(q):n(t,i)}return n(t,i)}}};var W=!1;function d(){if(!W){let r=T.handleMessageOnce("contentReady").then(()=>(W=!0,!0));return A.isContentReady(),Promise.race([r,new Promise(e=>{setTimeout(()=>{W||te.warn("waitPluginDone timeout"),e(!1)},5e3)})])}return Promise.resolve(W)}d();be();})();
